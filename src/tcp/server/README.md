# pongccheatstcp-server
The server bridging pongccheatstcp-client and pongccheatsd.


# Requirements
* Linux
* Python 3 at `python3` and pip at `pip3`
* pongccheatsd

# Starting
> venv is highly recommended. If you want to use it, make sure it is activated before proceeding.

Run `start.sh`.

# Documentation
This documentation describes the TCP protocol used to communicate between pongccheatstcp-client and pongccheatstcp-server.

## Types
The entire protocol revolves around a few key data types.
| type | description |
| --- | --- |
| u16 | Unsigned 16-bit integer |
| u32 | Unsigned 36-bit integer |
| bytes | Byte array prefixed with length as a u16 |
| string | utf-8 character array. You can read it by reading a byte array and parsing it as utf-8 |
| bool | Can be read as a 1-byte integer: 0 for false, 1 for true |

## Format
Packet are sent as ***big-endian*** binary data. Their format changes when encryption is enabled.

Format of an unencrypted packet:
| type | descrtiption |
| --- | --- |
| u16 | packet id |
| ... | packet data |

Format of an encrypted packet:
| type | descrtiption |
| --- | --- |
| bytes | Encrypted packet data |

Decrypting the packet data from an encrypted packet will give a result following the unencrypted packet form.

You can find more information about packet encryption [here](#encryption).

## Encryption
All symmetric encryption is performed using XChaCha20-Poly1305 as outlined [here](../client/client_service/native/README.md#documentation).

Upon starting, the server generates an RSA key pair (1024-bit in the case of pongccheatstcp-server, although this is an implementation-specific detail). This key pair is used for transferring the symmetric key.

## Packet IDs
The client sends a packet to the server and the server will respond with exactly one packet. The only packet the server sends that is not in immediate response to a packet from the client is Authenticate Now.

**Serverbound Packets**

***

*Hello (`0`)*

Greets the server.

***

*Encryption Response (`1`)*

Responds to the server's request to enable encryption. If the encryption test value does not match, the client will be kicked.

| name | type | description |
| --- | --- | --- |
| encrypted encryption key | bytes | The symmetric encryption key generated by the client encrypted with the server's public RSA key |
| encrypted test value | bytes | The test value sent by the server encrypted with the symmetric encryption key, used to test that the key was received properly |

***

*Authenticate (`2`)*

Authenticates with the server using a token provided by the auth server. If server fails to verify the token (i.e. the token is incorrect), the client will be kicked.

| name | type | description |
| --- | --- | --- |
| token | string | The token |

***

*Connect (`3`)*

Tells the server to connect to pongccheatsd.

***

*Attach (`4`)*

Tells the server to instruct pongccheatsd to attach to Pong C.

***

*Get Left Score (`5`)*

Tells the server to ask pongccheatsd for the left player's score.

***

*Get Right Score (`5`)*

Tells the server to ask pongccheatsd for the right player's score.

***

*Change Left Score (`6`)*

Tells the server to instruct pongccheatsd to change the left player's score.

| name | type | description |
| --- | --- | --- |
| score | u32 | The new score (in range [0, 999999]) |

***

*Change Right Score (`7`)*

Tells the server to instruct pongccheatsd to change the right player's score.

| name | type | description |
| --- | --- | --- |
| score | u32 | The new score (in range [0, 999999]) |

***

*Detach (`8`)*

Tells the server to instruct pongccheatsd to detach from Pong C.

***

**Clientbound Packets**

***

*Encryption Request (`0`)*

The server wants the client to enable encryption. Note that this isn't really a *request* per se; it would be more aptly named "Encryption Demand" as not following the request will result in the client being kicked.

Upon receiving this packet, the client should generate a random symmetric encryption key and send an Encryption Response packet containing the key encrypted with the server's public key and the encryption test value encrypted with the key.

| name | type | description |
| --- | --- | ---
| public key | bytes | The server's RSA public key (DER encoded SPKI) |
| encryption test value | bytes | Random data to test that the encryption is working properly |

***

*Enable Encryption (`1`)*

Upon receiving this packet, the client should start sending and receiving packets in encrypted form.

***

*Authenticate Now (`2`)*

The client must authenticate to proceed.

Note that this is the only packet the server sends that is not in immediate resonse to a packet from the client.

***

*Authenticated (`3`)*

The client has successfully authenticated

***

*Connect Response (`4`)*

Informs the client about how the connect message sent to pongccheatsd went. If it was unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Attach Response (`5`)*

Informs the client about how the attach message sent to pongccheatsd went. If it was unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Get Left Score Response (`6`)*

Gives the left score returned by pongccheatsd or an error. If unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| score | u32? | Only written if successful; the score |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Get Right Score Response (`7`)*

Gives the right score returned by pongccheatsd or an error. If unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| score | u32? | Only written if successful; the score |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Change Left Score Response (`8`)*

Informs the client about how the change left score message sent to pongccheatsd went. If it was unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Change Right Score Response (`9`)*

Informs the client about how the change right score message sent to pongccheatsd went. If it was unsuccessful, the client must send another Connect packet.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Detach Response (`10`)*

Informs the client about how the detach message sent to pongccheatsd went. The client must send another Connect packet after receiving this to continue communication with pongccheatsd.

| name | type | description |
| --- | --- | --- |
| ok | bool | Determines if the operation was successful |
| error | string? | Only written if unsuccessful; a message describing what went wrong |

***

*Kick (`65535`)*

The client has been kicked by the server. The server shuts down the socket immediately after sending this packet, the client must reconnect and start over again. Not sent for pongccheatsd errors, only sent for issues that occured pongccheatstcp-server (including bad packets from pongccheatstcp-client).

| name | type | description |
| --- | --- | --- |
| reason | string | User-readable string explaining why the client was kicked |

## Packet Order
The order in which packets must be sent is very specific and not following it results in the client being kicked. Listed below is the order that packets should be sent an received in, where S represents pongccheatstcp-server and C represents pongccheatstcp-client. Note that, at any point (even if not listed below), the server may send a Kick packet to the client.

```
C->S: HELLO
S->C: ENCRYPTION REQUEST
C->S: ENCRYPTION RESPONSE
S->C: ENABLE ENCRYPTION
S->C: AUTHENTICATE NOW
C->S: AUTHENTICATE
S->C: AUTHENTICATED
(forever):
    C->S: {
        CONNECT,
        ATTACH,
        GET LEFT SCORE,
        GET RIGHT SCORE,
        CHANGE LEFT SCORE,
        CHANGE RIGHT SCORE,
        DETACH
    }
    S->C: {
        CONNECT RESPONSE,
        ATTACH RESPONSE,
        GET LEFT SCORE RESPONES,
        CHANGE LEFT SCORE RESPONSE,
        CHANGE RIGHT SCORE RESPONSE,
        DETACH RESPONSE
    }
```
